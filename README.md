# ç½‘ç»œæŽ¢æµ‹æ•°æ® AI åˆ†æž Agent

åŸºäºŽ Python çš„ç½‘ç»œæŽ¢æµ‹æ•°æ® AI åˆ†æžç³»ç»Ÿï¼Œä½¿ç”¨ ClickHouse + RAG + Function Calling æŠ€æœ¯æ ˆã€‚

## åŠŸèƒ½ç‰¹æ€§

- ðŸ¤– **è‡ªç„¶è¯­è¨€æŸ¥è¯¢**ï¼šç”¨æˆ·å¯ä»¥ç›´æŽ¥ç”¨è‡ªç„¶è¯­è¨€æé—®ï¼Œç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ SQL
- ðŸ” **RAG å¢žå¼º**ï¼šåŸºäºŽæ•°æ®åº“ schema æ–‡æ¡£çš„å‘é‡æ£€ç´¢ï¼Œæé«˜ SQL ç”Ÿæˆå‡†ç¡®æ€§
- ðŸ›¡ï¸ **å®‰å…¨æŸ¥è¯¢**ï¼šè‡ªåŠ¨é™åˆ¶æŸ¥è¯¢è¡Œæ•°ã€åªå…è®¸ SELECTã€å¼ºåˆ¶æ—¶é—´èŒƒå›´ç­‰å®‰å…¨æœºåˆ¶
- ðŸ“Š **è‡ªåŠ¨å›¾è¡¨**ï¼šæ ¹æ®æŸ¥è¯¢ç»“æžœè‡ªåŠ¨ç”ŸæˆæŠ˜çº¿å›¾ã€æŸ±çŠ¶å›¾ç­‰å¯è§†åŒ–å›¾è¡¨
- ðŸ’¬ **æ™ºèƒ½åˆ†æž**ï¼šä½¿ç”¨ LLM å¯¹æŸ¥è¯¢ç»“æžœè¿›è¡Œè‡ªç„¶è¯­è¨€åˆ†æžå’Œè§£é‡Š

## æŠ€æœ¯æž¶æž„

```
User â†’ FastAPI /chat â†’ LLM â†’ RAG â†’ QueryPlan â†’ SQL â†’ ClickHouse â†’ DataFrame â†’ åˆ†æž â†’ è¿”å›žæ–‡å­—/å›¾è¡¨
```

### æ ¸å¿ƒæ¨¡å—

- **agent/llm.py**: LLM æ¨¡åž‹è°ƒç”¨å°è£…ï¼ˆGPT-4o miniï¼‰
- **agent/rag.py**: RAG å‘é‡æ£€ç´¢ï¼ˆåŸºäºŽ schema.mdï¼‰
- **agent/planner.py**: ç”¨æˆ·æ„å›¾ â†’ QueryPlan è½¬æ¢
- **agent/functions.py**: Function Calling å®žçŽ°ï¼ˆrun_query, draw_chartï¼‰
- **agent/analyzer.py**: ç»“æžœåˆ†æžå’Œè§£é‡Š
- **db/clickhouse_client.py**: ClickHouse å®‰å…¨æŸ¥è¯¢å®¢æˆ·ç«¯
- **db/schema.md**: æ•°æ®è¡¨ç»“æž„æ–‡æ¡£ï¼ˆRAG çŸ¥è¯†åº“ï¼‰
- **utils/chart.py**: Matplotlib å›¾è¡¨ç”Ÿæˆ
- **utils/time_utils.py**: æ—¶é—´èŒƒå›´è½¬æ¢å·¥å…·

## å¿«é€Ÿå¼€å§‹

### 1. çŽ¯å¢ƒè¦æ±‚

- Python 3.11+
- Docker & Docker Composeï¼ˆå¯é€‰ï¼‰

### 2. å®‰è£…ä¾èµ–

```bash
# è‡ªåŠ¨å®‰è£…ï¼ˆæŽ¨èï¼‰
python3 install_deps.py

# æˆ–æ‰‹åŠ¨å®‰è£…
pip3 install -r requirements.txt
```

### 3. é…ç½®

é…ç½®æ–‡ä»¶ä½äºŽ `config/settings.py`ï¼Œå·²åŒ…å«é»˜è®¤é…ç½®ï¼š

- LLM: GPT-4o miniï¼ˆå›½å†… API: geekai.coï¼‰
- ClickHouse: é˜¿é‡Œäº‘å®žä¾‹ï¼ˆå·²é…ç½®ï¼‰

å¦‚éœ€ä¿®æ”¹ï¼Œå¯ç¼–è¾‘ `config/settings.py` æˆ–åˆ›å»º `.env` æ–‡ä»¶ã€‚

### 4. è¿è¡Œ

#### æ–¹å¼ä¸€ï¼šCLI å‘½ä»¤è¡Œæ¨¡å¼ï¼ˆæŽ¨èç”¨äºŽæµ‹è¯•ï¼‰

```bash
# ä½¿ç”¨é»˜è®¤é—®é¢˜æµ‹è¯•
python3 cli.py

# ä½¿ç”¨è‡ªå®šä¹‰é—®é¢˜
python3 cli.py -q "ç»Ÿè®¡è¿‘1hçš„RTTæƒ…å†µ"

# é™é»˜æ¨¡å¼ï¼ˆåªæ˜¾ç¤ºæœ€ç»ˆç»“æžœï¼‰
python3 cli.py --quiet

# æµ‹è¯•æ¨¡å¼ï¼ˆè¿è¡Œå¤šä¸ªæµ‹è¯•é—®é¢˜ï¼‰
python3 cli.py --test

# æˆ–ä½¿ç”¨ app.pyï¼ˆæ”¯æŒ CLI æ¨¡å¼ï¼‰
python3 app.py -q "ä½ çš„é—®é¢˜"
```

#### æ–¹å¼äºŒï¼šå¯åŠ¨ FastAPI æœåŠ¡

```bash
python3 app.py
```

æˆ–ä½¿ç”¨ uvicornï¼š

```bash
uvicorn app:app --host 0.0.0.0 --port 8000
```

#### æ–¹å¼äºŒï¼šDocker è¿è¡Œ

```bash
docker compose up -d
```

### 5. è®¿é—®

- API æ–‡æ¡£: http://localhost:8000/docs
- å¥åº·æ£€æŸ¥: http://localhost:8000/health

## API ä½¿ç”¨ç¤ºä¾‹

### POST /chat

å‘é€è‡ªç„¶è¯­è¨€æŸ¥è¯¢ï¼š

```bash
curl -X POST "http://localhost:8000/chat" \
  -H "Content-Type: application/json" \
  -d '{
    "message": "æŸ¥çœ‹ç”µä¿¡è¾½å®è¿‡åŽ»30åˆ†é’Ÿè®¿é—®ä¸Šæµ·çš„RTTè¶‹åŠ¿å¹¶ç”»å›¾"
  }'
```

å“åº”ç¤ºä¾‹ï¼š

```json
{
  "answer": "è¿‡åŽ» 30 åˆ†é’Ÿ RTT å‘ˆçŽ°è½»å¾®ä¸‹é™è¶‹åŠ¿...",
  "chart_url": "/static/chart_20250101_120000.png",
  "sql": "SELECT src_province, AVG(avg_rtt) as avg_rtt, COUNT(*) as count\nFROM detect.detect_ping_log\nWHERE timestamp >= 1704067200 AND timestamp <= 1704069000\nAND src_isp IN ('chinatelecom')\nAND src_province IN ('liaoning')\nGROUP BY src_province\nORDER BY src_province\nLIMIT 1000000"
}
```

## æŸ¥è¯¢ç¤ºä¾‹

- "æŸ¥è¯¢è¿‡åŽ»ä¸€å°æ—¶å…¨å›½ä¸‰å¤§è¿è¥å•†çš„ä¸¢åŒ…çŽ‡æƒ…å†µ"
- "åˆ†æž edge_l1_detect ä»»åŠ¡çš„æ˜¨æ—¥ RTT æ³¢åŠ¨è¶‹åŠ¿"
- "ç»˜åˆ¶è¾½å®åˆ°ä¸Šæµ·ã€ç”µä¿¡è¿è¥å•†çš„ RTT åˆ†å¸ƒå›¾"
- "æŸ¥çœ‹è¿‡åŽ»24å°æ—¶å„çœä»½çš„å¹³å‡å»¶è¿Ÿ"

## å®‰å…¨æœºåˆ¶

1. **æŸ¥è¯¢é™åˆ¶**ï¼šæœ€å¤š 100 ä¸‡è¡Œï¼ˆè‡ªåŠ¨æ³¨å…¥ LIMITï¼‰
2. **æ“ä½œé™åˆ¶**ï¼šåªå…è®¸ SELECT æŸ¥è¯¢
3. **SQL æ³¨å…¥é˜²æŠ¤**ï¼šä¸ç›´æŽ¥æ‰§è¡Œç”¨æˆ· SQLï¼Œé€šè¿‡ QueryPlan ç”Ÿæˆ
4. **æ—¶é—´èŒƒå›´å¼ºåˆ¶**ï¼šå¿…é¡»åŒ…å« time_range
5. **å±é™©å…³é”®å­—è¿‡æ»¤**ï¼šè‡ªåŠ¨è¿‡æ»¤ insertã€alterã€dropã€delete ç­‰
6. **ç»“æžœå¤§å°æŽ§åˆ¶**ï¼šè¿”å›žè¡Œæ•°è¿‡å¤§æ—¶è‡ªåŠ¨é™åˆ¶

## é¡¹ç›®ç»“æž„

```
project/
 â”œâ”€â”€ app.py                     # FastAPI ä¸»å…¥å£
 â”œâ”€â”€ agent/
 â”‚   â”œâ”€â”€ llm.py                 # æ¨¡åž‹è°ƒç”¨
 â”‚   â”œâ”€â”€ rag.py                 # schema æ–‡æ¡£å‘é‡åº“
 â”‚   â”œâ”€â”€ planner.py             # ç”¨æˆ·æ„å›¾ â†’ QueryPlan
 â”‚   â”œâ”€â”€ functions.py           # function calling
 â”‚   â””â”€â”€ analyzer.py            # æ•°æ®åˆ†æž
 â”œâ”€â”€ db/
 â”‚   â”œâ”€â”€ clickhouse_client.py   # CH æŸ¥è¯¢ + é™åˆ¶é€»è¾‘
 â”‚   â””â”€â”€ schema.md              # detect_ping_log ç»“æž„
 â”œâ”€â”€ config/
 â”‚   â””â”€â”€ settings.py            # æ¨¡åž‹ä¸Žæ•°æ®åº“é…ç½®
 â”œâ”€â”€ utils/
 â”‚   â”œâ”€â”€ chart.py               # ç»˜å›¾
 â”‚   â””â”€â”€ time_utils.py           # æ—¶é—´å·¥å…·
 â”œâ”€â”€ static/                     # å›¾è¡¨å­˜å‚¨ç›®å½•
 â”œâ”€â”€ tests/                      # æµ‹è¯•ç›®å½•
 â”œâ”€â”€ docker-compose.yml
 â”œâ”€â”€ Dockerfile
 â””â”€â”€ README.md
```

## å¼€å‘è¯´æ˜Ž

### ä»£ç è§„èŒƒ

- ä½¿ç”¨**å«è¯­å¥**ï¼ˆGuard Clausesï¼‰è®¾è®¡ï¼Œæå‰è¿”å›žï¼Œå‡å°‘åµŒå¥—
- æ ‡å‡†åŒ–ã€å·¥ç¨‹åŒ–ä»£ç ç»“æž„
- å®Œæ•´çš„ç±»åž‹æ³¨è§£å’Œé”™è¯¯å¤„ç†
- æ—¥å¿—è®°å½•å…³é”®æ“ä½œ

### æ‰©å±•å¼€å‘

1. **æ·»åŠ æ–°çš„èšåˆæ–¹å¼**ï¼šä¿®æ”¹ `agent/planner.py` ä¸­çš„ `QUERY_PLAN_FUNCTION`
2. **æ·»åŠ æ–°çš„å›¾è¡¨ç±»åž‹**ï¼šä¿®æ”¹ `utils/chart.py` ä¸­çš„ `draw_chart` å‡½æ•°
3. **æ‰©å±• RAG çŸ¥è¯†åº“**ï¼šæ›´æ–° `db/schema.md` æ–‡æ¡£

## æ³¨æ„äº‹é¡¹

1. **é¦–æ¬¡è¿è¡Œ**ï¼šRAG æ¨¡å—éœ€è¦ä¸‹è½½åµŒå…¥æ¨¡åž‹ï¼Œå¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´
2. **SQL è¾“å‡º**ï¼šæ¯æ¬¡æŸ¥è¯¢éƒ½ä¼šåœ¨å“åº”ä¸­è¿”å›žç”Ÿæˆçš„ SQLï¼Œæ–¹ä¾¿è¯„ä¼°æŸ¥è¯¢æ­£ç¡®æ€§
3. **å›¾è¡¨å­˜å‚¨**ï¼šå›¾è¡¨ä¿å­˜åœ¨ `static/` ç›®å½•ï¼Œé€šè¿‡ `/static/` è·¯å¾„è®¿é—®
4. **æ—¶é—´æ ¼å¼**ï¼šæ”¯æŒ `last_30_min`, `last_1_hour`, `last_24_hour` ç­‰ç›¸å¯¹æ—¶é—´æ ¼å¼

## è®¸å¯è¯

MIT License

